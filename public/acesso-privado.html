<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Define a codificação de caracteres para UTF-8, que cobre a maioria dos caracteres de línguas humanas -->
  <meta charset="UTF-8">
  <!-- Define a configuração para que a página seja responsiva e ajustável conforme o tamanho da tela do dispositivo -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Título da página que aparecerá na aba do navegador -->
  <title>Privado</title>
  <!-- Link para o arquivo CSS que define os estilos da página -->
  <link rel="stylesheet" href="assets/privado.css">
</head>

<body>
  <!-- Título principal da página informando que a página é restrita a usuários logados -->
  <h1>Apenas usuários logados podem acessar esta página</h1>
  
  <!-- Botão para o usuário fazer logout -->
  <button id="logout">Sair</button>
  
  <!-- Botão para carregar a lista de usuários -->
  <button id="btn">Carregar lista</button>
  
  <!-- Botão para abrir o modal de edição de dados do usuário -->
  <button id="update" onclick="openEditForm()">Alterar</button>
  
  <!-- Novo botão para adicionar um filme -->
  <button id="addMovieBtn" onclick="redirectToAddMoviePage()">Adicionar Filme</button>

  <!-- Modal para edição de dados do usuário -->
  <dialog id="modal">
    <form method="dialog">
      <h2>Editar Dados</h2>
      
      <!-- Formulário de senha para o usuário confirmar antes de alterar os dados -->
      <div id="passwordForm">
        <!-- Campo para a senha atual -->
        <label for="currentPassword">Senha Atual:</label>
        <input type="password" id="currentPassword" name="currentPassword" placeholder="Digite sua senha atual" required><br><br>

        <!-- Campo para o novo email -->
        <label for="newEmail">Novo Email:</label>
        <input type="email" id="newEmail" name="newEmail" placeholder="Digite o novo email" required><br><br>

        <!-- Campo para a nova senha -->
        <label for="newPassword">Nova Senha:</label>
        <input type="password" id="newPassword" name="newPassword" placeholder="Digite a nova senha" required><br><br>

        <!-- Botão para confirmar a alteração -->
        <button type="button" onclick="validatePassword()">Confirmar</button>
        <!-- Botão para cancelar a edição e fechar o modal -->
        <button type="button" onclick="cancelEdit()">Cancelar</button>
      </div>
    </form>
  </dialog>

  <!-- Contêiner onde a lista de usuários será exibida -->
  <div id="container">
    <!-- Aqui serão exibidos os dados dos usuários carregados -->
  </div>

  <script>
    // Obtém o elemento onde a lista de usuários será exibida
    const container = document.getElementById('container');
    
    // Função para carregar a lista de usuários
    async function load() {
      const url = '/user/list'; // URL para buscar a lista de usuários
      const headers = { 'Authorization': `${localStorage.getItem('token')}` }; // Cabeçalho com token de autenticação do localStorage
      const response = await fetch(url, { method: 'GET', headers }); // Faz uma requisição GET à API de usuários

      if (!response.ok) { // Se a resposta não for bem-sucedida (por exemplo, se o usuário não estiver logado)
        alert('Você não está logado... Redirecionando para o login...'); // Exibe alerta de erro
        return window.location = '/'; // Redireciona para a página de login
      }

      const dataResponse = await response.json(); // Converte a resposta para JSON
      container.innerHTML = ''; // Limpa o conteúdo do container
      dataResponse.forEach(e => { // Para cada usuário na lista
        const el = document.createElement('p'); // Cria um novo elemento <p>
        el.innerText = `ID: ${e.id}, Nome: ${e.name}, Email: ${e.email}`; // Preenche o <p> com as informações do usuário
        container.appendChild(el); // Adiciona o <p> no container
      });
    }

    // Ao clicar no botão "Carregar lista", chama a função load para carregar os dados
    document.getElementById('btn').addEventListener('click', load);

    // Função para logout
    const logoutBtn = document.getElementById('logout'); // Obtém o botão de logout
    logoutBtn.addEventListener('click', () => { // Quando o botão de logout é clicado
      localStorage.clear(); // Limpa o token de autenticação armazenado no localStorage
      window.location = '/acesso-publico.html'; // Redireciona para a página pública (login)
    });

    // Função para abrir o modal de edição de dados do usuário
    function openEditForm() {
      const modal = document.getElementById('modal'); // Obtém o modal
      modal.showModal(); // Abre o modal para edição
    }

    // Função para cancelar a edição e fechar o modal
    function cancelEdit() {
      const modal = document.getElementById('modal'); // Obtém o modal
      modal.close(); // Fecha o modal
    }

    // Função para validar a senha atual e permitir a atualização dos dados do usuário
    async function validatePassword() {
      // Obtém os valores dos campos do formulário
      const currentPassword = document.getElementById('currentPassword').value;
      const newEmail = document.getElementById('newEmail').value;
      const newPassword = document.getElementById('newPassword').value;

      const userEmail = 'joao.silva@email.com'; // Exemplo de email do usuário logado (idealmente, viria da sessão ou do JWT)

      // Envia a requisição de login para validar a senha atual
      const response = await fetch('/user/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: userEmail, password: currentPassword })
      });

      if (!response.ok) { // Se a senha estiver incorreta
        alert('Senha incorreta!'); // Exibe alerta de erro
        return;
      }

      // Se a senha for válida, prepara os dados para atualização
      const userData = {
        email: userEmail,
        newEmail: newEmail,
        password: newPassword
      };

      // Envia a requisição para atualizar os dados do usuário
      const updateResponse = await fetch('/user/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });

      if (updateResponse.ok) { // Se a atualização for bem-sucedida
        alert('Dados atualizados com sucesso!'); // Exibe mensagem de sucesso
        cancelEdit(); // Fecha o modal
      } else {
        alert('Erro ao atualizar os dados.'); // Se algo deu errado, exibe mensagem de erro
      }
    }

    // Função para redirecionar o usuário para a página de adicionar filme
    function redirectToAddMoviePage() {
      window.location.href = "/adicionar-filme.html"; // Redireciona para a página de adicionar filme
    }
  </script>
</body>

</html>
